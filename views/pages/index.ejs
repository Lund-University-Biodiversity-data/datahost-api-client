<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head'); %>
</head>

<header>
  <%- include('../partials/headerLU'); %>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <style>
    #map { height: 360px; }
  </style>

  <script src="tablefilter/dist/tablefilter/tablefilter.js"></script>

  <!-- Add icon library -->
  <link href="@fortawesome/fontawesome-free/css/fontawesome.css" rel="stylesheet">
  <link href="@fortawesome/fontawesome-free/css/brands.css" rel="stylesheet">
  <link href="@fortawesome/fontawesome-free/css/solid.css" rel="stylesheet">

  <link rel="stylesheet" href="css/client.css">

  <!-- LEAFLET -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
     integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
     crossorigin=""/>
  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
   integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
   crossorigin=""></script>

  <!-- LEAFLET draw -->

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>

  <!-- end LEAFLET -->

  <!-- multiple select bootstrap -->

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">


  <!-- Latest compiled and minified JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

  <!-- end multiple select bootstrap -->



  <script src="js/client.js"></script>


</header>


<body>

<main>

  <div class="container">

    <!--
    <div>
      <%= inputArea[0] %>
      <%= inputArea[1] %>
      <%= inputArea[2] %>
    </div>
    -->

    <div class="">
      <h1>Datahost Client API - Sök och ladda ner data</h1>

      <% if (errorMsg != "") { %>
      <div class="alert alert-danger" role="alert">
        <%= errorMsg %>
      </div>
      <% } %>

      <div class="">

        <p>Med hjälp av filtren här nedan kan du söka ut data. Gör du inget aktivt val baseras sökningen automatiskt på samtliga valmöjligheter. </p>
        <p>Resultatet kan laddas ner som en kommaseparerad csv-fil eller en xlsx-fil.</p>
        <p>Du hittar utförliga instruktioner via den här länken.</p>


        <form action="/" method="POST">


          <div class="form-group mb-3">
            <h3 title="”Artobservationer” är det mest informationsrika utsnittet av data du kan få, från t.ex. antal av arten du valt till metadata om delprogrammet som observationen gjorts i. Läs mer om de olika alternativen i instruktionsdokumentet. ">Typ av information <i class="fa-regular fa-circle-info"></i></h3>
            <select name="inputObject" class="form-control">
              <option value="Occurrence" <%= (inputObject=="Occurrence" ? "selected" : "") %>>Artobservationer</option>
              <option value="Event" <%= (inputObject=="Event" ? "selected" : "") %>>Inventeringstillfällen</option>
              <option value="Dataset" <%= (inputObject=="Dataset" ? "selected" : "") %>>Delprogram/Metadata</option>
            </select>
          </div>

          <hr>
          <h3>Direct downlad section</h3>
          <div class="form-group mb-3">
            <% for (var i = 0; i < availableDatasets.length; i++) { %>
              <p><a href="<%= availableDatasets[i]['downloadPath'] %>" target="_blank"><%= availableDatasets[i]['displayName'] %></a></p>
            <% } %>          
          </div>

          <hr>

          <h3 title="blabla">Data från specifika delprogram <i class="fa-regular fa-circle-info"></i></h3>
          <div class="form-group mb-3">
            <label>
              <span class="all-none-button" id="selectAllDatasets"><i class="fa-regular fa-square-check"></i> av/markera alla</span>
              <input type="hidden" id="tokenMarkAllDatasets" value=0>
            </label>
            <% for (var i = 0; i < availableDatasets.length; i++) { %>
              <div class="form-check">
                <input class="form-check-input datasets-list-checkbox" type="checkbox" value="<%= availableDatasets[i]['datasetID'] %>" id="dataset<%= i %>" name="datasetCheckB" <% if (inputDatasetList.includes(availableDatasets[i]['datasetID'])) { %>checked<% } %> >
                <label class="form-check-label" for="dataset<%= i %>">
                  <%= availableDatasets[i]['displayName'] %>
                </label>
              </div>
            <% } %>
          </div>        

          <hr>

          <h3 title="Använd antingen kryssrutorna eller rullmenyn. Flera grupper respektive arter kan väljas.">Taxon <i class="fa-regular fa-circle-info"></i></h3>

          <div class="form-group mb-3">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="radioTaxon" id="radioTaxonAll" value="taxonAll">
              <label class="form-check-label" for="radioTaxonAll">Alla</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="radioTaxon" id="radioTaxonBirds" value="taxonBirds">
              <label class="form-check-label" for="radioTaxonBirds">Fåglar</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="radioTaxon" id="radioTaxonButterflies" value="taxonButterflies">
              <label class="form-check-label" for="radioTaxonButterflies">Fjärillar</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="radioTaxon" id="radioTaxonMammals" value="taxonMammals">
              <label class="form-check-label" for="radioTaxonMammals">Däggdjjur</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="radioTaxon" id="radioTaxonAmphibians" value="taxonAmphibians">
              <label class="form-check-label" for="radioTaxonAmphibians">Groddjjur</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="radioTaxon" id="radioTaxonClear" value="taxonClear">
              <label class="form-check-label" for="radioTaxonClear">Clear selection</label>
            </div>
          </div>

          <div class="form-group mb-3" id="divTaxonList">
            <select id="inputTaxon" name="inputTaxon" class="form-control selectpicker" multiple title="Choose one of the following..." data-live-search="true">

              <% Object.entries(tableTaxon).forEach(function([key, val]) { %>
                  <option value="<%= tableTaxon[key].id %>"  <%= (inputTaxon.includes(tableTaxon[key].id) ? "selected" : "") %>><%- tableTaxon[key].data %></option>
              <% }); %>    
            </select>

          </div>

          
          <hr>

          <h3 title="blabla">Tidsperiod <i class="fa-regular fa-circle-info"></i></h3>
          <div class="form-group mb-3">
            <label>Från datum</label>
            <input type="date" class="form-control" placeholder="YYYY-MM-DD" name="inputStartDate" value="<%= inputStartDate %>">
          </div>
          <div class="form-group mb-3">
            <label>Till datum</label>
            <input type="date" class="form-control" placeholder="YYYY-MM-DD" name="inputEndDate" value="<%= inputEndDate %>">
          </div>
          <!--
          <div class="form-group mb-3">
            <label>Date filter</label>
            <select name="inputDateType" class="form-control">
              <option value="OverlappingStartDateAndEndDate" <%= (inputDateType=="OverlappingStartDateAndEndDate" ? "selected" : "") %>>OverlappingStartDateAndEndDate</option>
              <option value="BetweenStartDateAndEndDate" <%= (inputDateType=="BetweenStartDateAndEndDate" ? "selected" : "") %>>BetweenStartDateAndEndDate</option>
            </select>
          </div>
          -->


          <hr>

          <h3 title="Begränsa din sökning geografiskt genom att antingen välja län eller kommun i rullmenyerna, eller genom att markera ett område i kartan. Observera: framsökt data kommer inte att visas i kartan.">Geografiskt område <i class="fa-regular fa-circle-info"></i></h3>
          <div class="form-group mb-3">
            <label>Välj inget, ett eller flera län</label>
            <select name="inputCounty" class="form-control selectpicker"  multiple title="Choose one of the following...">
              <% for (var i = 0; i < tableCounty.length; i++) { %>
                <option value="<%= tableCounty[i] %>"  <%= (inputCounty.includes(tableCounty[i]) ? "selected" : "") %>><%= tableCounty[i] %></option>
              <% } %>
            </select>
          </div>

          <label>Rita en polygon</label>
          <div id="map"></div>
          <div class="form-group mb-3">
            <label>Bounding box</label>
            <input type="text" class="form-control" name="inputArea" id="inputArea" value="<%= inputArea %>" readOnly=true>
          </div>

          <hr>



          <hr>


          <input type="hidden" id="inputSourceSubmit" name="inputSourceSubmit" value="">
          <div class="d-grid mt-3">
            <button type="submit" class="btn btn-primary">View in a table</button>
          </div>
          <!--
          <div class="d-grid mt-3">
            <button id="downloadButton" class="btn btn-danger">Generate CSV (OLD)</button>
          </div>
        -->
          <div class="d-grid mt-3">
            <button id="buttonExportCsv" class="btn btn-primary">Generate CSV</button>
          </div>
          <div class="d-grid mt-3">
            <button id="buttonExportXlsx" class="btn btn-primary">Generate XLSX</button>
          </div>
        </form>
      </div>
    </div>

          <hr>

    <% if (locals.downloadFile && downloadFile != "") { %>
      <a href="<%- downloadFile %>" class="btn"><i class="fa fa-download"></i> Download</a>
    <% } %>
    <br>

    <% if (isDataTable) { %>
      <div class="divTable">

        <h3 title="Här visas bara ett urval av fält från databasen, men i nedladdade filer ingår alla fält som det finns data för.">Resultat och nedladdning <i class="fa-regular fa-circle-info"></i></h3>
        <h3><%= tableData.length %> result(s)</h3>
        <% if (totalResults != tableData.length ) { %>
        <p><%- totalResults %> result(s) obtained but table display limited to <%= maxResults %> results.</p>
        <% } %>
        <table id="resultTable">
          <thead>
              <tr>
                <% for (var i = 0; i < tableColumns.length; i++) { %>
                  <th><%= tableColumns[i] %></th>
                <% } %>
              </tr>
          </thead>
          <tbody>
            <% for (var i = 0; i < tableData.length; i++) { %>
              <tr>
                <% Object.keys(tableData[i]).forEach(function(key) { %>
                 <td><%= tableData[i][key] %></td>
                <% }); %>    
              </tr>
            <% } %>
          </tbody>
        </table>

      </div>
    <% } %>

  </div> <!-- end container -->
</main>

<footer>
  <%- include('../partials/footer'); %>
</footer>

</body>
</html>
