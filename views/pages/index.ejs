<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head'); %>
</head>
<body class="container">

<header>
  <%- include('../partials/header'); %>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <style>
    #map { height: 360px; }
  </style>

  <script src="tablefilter/dist/tablefilter/tablefilter.js"></script>

  <!-- Add icon library -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <!-- LEAFLET -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
     integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
     crossorigin=""/>
  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
   integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
   crossorigin=""></script>

  <!-- LEAFLET draw -->

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>

  <!-- end LEAFLET -->




  <!-- multiple select bootstrap -->

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

  <!-- end multiple select bootstrap -->


  <script>

    $(document).ready(function () {

      $('input[name="radioTaxon"]').on('click', function() {
        if ($(this).attr('id')!="radioTaxonAll") {
          //$("#divTaxonList").css("display", "none");

          $('select[name=inputTaxon]').val('').selectpicker('deselectAll');

          switch ($(this).attr('id')) {
            case "radioTaxonBirds":
              
              $('select[name=inputTaxon]').val(4000104).selectpicker("refresh");;
              break;
            case "radioTaxonKrak":
              $('select[name=inputTaxon]').val(2002118).selectpicker("refresh");;
              break;
          }
          
        }
        else {
          //$("#divTaxonList").css("display", "inline");
        }
      });


      $(function () {
        $('.selectpicker').selectpicker();
      });

      /*
      $('#downloadButton').on('click', function() {
        $('#inputSourceSubmit').val("download");
      });
      */

      $('#buttonExportCsv').on('click', function() {
        $('#inputSourceSubmit').val("exportCsv");
      });

      var map = L.map('map').setView([62.47204526039855, 16.149376718556645], 4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '© OpenStreetMap'
      }).addTo(map);
      // FeatureGroup is to store editable layers
      //var drawnItems = new L.FeatureGroup();
      //map.addLayer(drawnItems);
      var drawControl = new L.Control.Draw({
         draw: {
             polygon: false,
             marker: false,
             polyline: false,
             circle: false
         }
      });
      map.addControl(drawControl);


      if ($("#inputArea").val()!="") {
        //alert("yes");
        var bounds= <%- JSON.stringify(inputArea) %>;
        //console.log(bounds);

        var rect = L.rectangle(bounds, {color: 'blue', weight: 1}).on('click', function (e) {
            // There event is event object
            // there e.type === 'click'
            // there e.lanlng === L.LatLng on map
            // there e.target.getLatLngs() - your rectangle coordinates
            // but e.target !== rect
            console.info(e);
        }).addTo(map);
        //alert("rect");

      }

      // event when object drawn on the map
      map.on('draw:created', function (e) {
        var type = e.layerType,
            layer = e.layer;

        if (type === 'marker') {
            // Do marker specific actions
        }

        if (type === 'rectangle' || type === 'polygon') {
          //layer.on('mouseover', function() {   });

          $('#inputArea').val(layer.getLatLngs());
        }

        // Do whatever else you need to. (save to db, add to map etc)
        map.addLayer(layer);
      });



      // check if the element exists
      if ($('#resultTable').length > 0) {

        var filtersConfig = {
            base_path: 'tablefilter/',
            paging: {
              results_per_page: ['Records: ', [10, 25, 50, 100]]
            },
            state: {
              types: ['local_storage'],
              filters: true,
              page_number: true,
              page_length: true,
              sort: true
            },
            alternate_rows: true,
            btn_reset: true,
            rows_counter: true,
            loader: {
              html: '<div id="lblMsg"></div>',
              css_class: 'myLoader'
            },
            status_bar: {
              target_id: 'lblMsg',
              css_class: 'myStatus'
            },
            col_0: 'select',
            col_1: 'select',
            col_2: 'select',
            col_types: [
                'string', 'string', 'number',
                'number', 'number', 'number',
                'number', 'number', 'number'
            ],
            extensions:[{
                name: 'sort'
            }]
        };
        var tf = new TableFilter('resultTable', filtersConfig);


        tf.init();

      }
    });

  </script>

</header>

<main>

  <div>
    <%= inputArea[0] %>
    <%= inputArea[1] %>
    <%= inputArea[2] %>
  </div>

  <div class="">
    <h1>Browse LU data</h1>

    <div class="">

      <form action="/" method="POST">

        <div class="form-group mb-3">
          <label>Pick an object</label>
          <select name="inputObject" class="form-control">
            <option value="Event" <%= (inputObject=="Event" ? "selected" : "") %>>Events</option>
            <option value="Dataset" <%= (inputObject=="Dataset" ? "selected" : "") %>>Datasets</option>
            <option value="Occurrence" <%= (inputObject=="Occurrence" ? "selected" : "") %>>Occurrences</option>
          </select>
        </div>

        <h3>Dataset filter</h3>
        <div class="form-group mb-3">
          <label>Select 0 to n datasets</label>
          <% for (var i = 0; i < availableDatasets.length; i++) { %>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="<%= availableDatasets[i]['datasetID'] %>" id="dataset<%= i %>" name="datasetCheckB" <% if (inputDatasetList.includes(availableDatasets[i]['datasetID'])) { %>checked<% } %> >
              <label class="form-check-label" for="dataset<%= i %>">
                <%= availableDatasets[i]['displayName'] %>
              </label>
            </div>
          <% } %>
        </div>        

        <h3>Area</h3>
        <div class="form-group mb-3">
          <label>Län</label>
          <select name="inputCounty" class="form-control selectpicker"  multiple title="Choose one of the following...">
            <% for (var i = 0; i < tableCounty.length; i++) { %>
              <option value="<%= tableCounty[i] %>"  <%= (inputCounty.includes(tableCounty[i]) ? "selected" : "") %>><%= tableCounty[i] %></option>
            <% } %>
          </select>
        </div>

        <div id="map"></div>
        <div class="form-group mb-3">
          <label>Bounding box</label>
          <input type="text" class="form-control" name="inputArea" id="inputArea" value="<%= inputArea %>" readOnly=true>
        </div>

        <h3>Taxon</h3>

        <div class="form-group mb-3">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="radioTaxon" id="radioTaxonAll" value="taxonAll">
            <label class="form-check-label" for="radioTaxonAll">All list</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="radioTaxon" id="radioTaxonBirds" value="taxonBirds">
            <label class="form-check-label" for="radioTaxonBirds">Birds</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="radioTaxon" id="radioTaxonKrak" value="taxonKrak">
            <label class="form-check-label" for="radioTaxonKrak">Kråkfåglar</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="radioTaxon" id="radioTaxonClear" value="taxonClear">
            <label class="form-check-label" for="radioTaxonClear">Clear selection</label>
          </div>
          <!--
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="radioTaxon" id="radioTaxonButterflies" value="taxonButterflies">
            <label class="form-check-label" for="radioTaxonButterflies">Butterflies</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="radioTaxon" id="radioTaxonOwls" value="taxonOwls">
            <label class="form-check-label" for="radioTaxonOwls">Owls</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="radioTaxon" id="radioTaxonMammals" value="taxonMammals">
            <label class="form-check-label" for="radioTaxonMammals">Mammals</label>
          </div>
        -->
        </div>

        <div class="form-group mb-3" id="divTaxonList">
          <select id="inputTaxon" name="inputTaxon" class="form-control selectpicker" multiple title="Choose one of the following..." data-live-search="true">

            <% Object.entries(tableTaxon).forEach(function([key, val]) { %>
                <option value="<%= tableTaxon[key].id %>"  <%= (inputTaxon.includes(tableTaxon[key].id) ? "selected" : "") %>><%- tableTaxon[key].data %></option>
            <% }); %>    
          </select>

        </div>

        
        <h3>Dates</h3>
        <div class="form-group mb-3">
          <label>Start Date</label>
          <input type="date" class="form-control" placeholder="YYYY-MM-DD" name="inputStartDate" value="<%= inputStartDate %>">
        </div>
        <div class="form-group mb-3">
          <label>End Date</label>
          <input type="date" class="form-control" placeholder="YYYY-MM-DD" name="inputEndDate" value="<%= inputEndDate %>">
        </div>
        <!--
        <div class="form-group mb-3">
          <label>Date filter</label>
          <select name="inputDatumType" class="form-control">
            <option value="OverlappingStartDateAndEndDate" <%= (inputDatumType=="OverlappingStartDateAndEndDate" ? "selected" : "") %>>OverlappingStartDateAndEndDate</option>
            <option value="BetweenStartDateAndEndDate" <%= (inputDatumType=="BetweenStartDateAndEndDate" ? "selected" : "") %>>BetweenStartDateAndEndDate</option>
          </select>
        </div>
        -->

        <input type="hidden" id="inputSourceSubmit" name="inputSourceSubmit" value="">
        <div class="d-grid mt-3">
          <button type="submit" class="btn btn-danger">View in a table</button>
        </div>
        <!--
        <div class="d-grid mt-3">
          <button id="downloadButton" class="btn btn-danger">Generate CSV (OLD)</button>
        </div>
      -->
        <div class="d-grid mt-3">
          <button id="buttonExportCsv" class="btn btn-danger">Generate CSV - NEW</button>
        </div>
      </form>
    </div>
  </div>

  <% if (locals.downloadFile && downloadFile != "") { %>
    <a href="<%- downloadFile %>" class="btn"><i class="fa fa-download"></i> Download</a>
  <% } %>
  <br>

  <% if (isDataTable) { %>
    <div class="divTable">
      <h3><%= tableData.length %> result(s)</h3>
      <% if (totalResults != tableData.length ) { %>
      <p><%- totalResults %> result(s) obtained but table display limited to <%= maxResults %> results.</p>
      <% } %>
      <table id="resultTable">
        <thead>
            <tr>
              <% for (var i = 0; i < tableColumns.length; i++) { %>
                <th><%= tableColumns[i] %></th>
              <% } %>
            </tr>
        </thead>
        <tbody>
          <% for (var i = 0; i < tableData.length; i++) { %>
            <tr>
              <% Object.keys(tableData[i]).forEach(function(key) { %>
               <td><%= tableData[i][key] %></td>
              <% }); %>    
            </tr>
          <% } %>
        </tbody>
      </table>

    </div>
  <% } %>

</main>

<footer>
  <%- include('../partials/footer'); %>
</footer>

</body>
</html>
